@page "/character"
@attribute [StreamRendering]
@rendermode InteractiveServer
@inject IEveAuthenticationService AuthService
@inject IEsiApiService EveApi
@inject NavigationManager Navigation
@inject ILogger<Character> Logger
@inject ISdeService SdeService
@using WALLEve.Components.Character

<PageTitle>EVE Companion - Charakter</PageTitle>

<div class="character-page">
    @if (_isLoading)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>@_loadingStatus</p>
        </div>
    }
    else if (!_isAuthenticated)
    {
        <div class="not-authenticated">
            <h2>Nicht angemeldet</h2>
            <p>Du musst dich anmelden, um deine Charakterdaten zu sehen.</p>
            <a href="/" class="button">Zur Anmeldung</a>
        </div>
    }
    else if (_errorMessage != null)
    {
        <div class="error">
            <h2>Fehler beim Laden</h2>
            <p>@_errorMessage</p>
            <button class="button" @onclick="LoadCharacterData">Erneut versuchen</button>
        </div>
    }
    else if (_overview == null)
    {
        <div class="error">
            <h2>Keine Daten</h2>
            <p>Die Charakterdaten konnten nicht geladen werden.</p>
            <button class="button" @onclick="LoadCharacterData">Erneut versuchen</button>
        </div>
    }
    else
    {
        <CharacterHeader Overview="_overview" />

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-button @(_activeTab == "overview" ? "active" : "")"
                    @onclick="@(() => SwitchTabAsync("overview"))">
                ðŸ“Š Ãœbersicht
            </button>
            <button class="tab-button @(_activeTab == "skills" ? "active" : "")"
                    @onclick="@(() => SwitchTabAsync("skills"))">
                ðŸŽ“ Skills
            </button>
        </div>

        <!-- Overview Tab -->
        @if (_activeTab == "overview")
        {
            <div class="tab-content">
                <div class="character-grid">
                    <AffiliationCard Overview="_overview" />
                    <WalletCard WalletBalance="_overview.WalletBalance" />
                    <LocationCard SystemInfo="_systemInfo" CurrentSystem="_overview.CurrentSystem" />
                    <ShipCard CurrentShip="_overview.CurrentShip" ShipType="_overview.ShipType" ShipClass="_shipClass" />
                    <DetailsCard Character="_overview.Character" OnlineStatus="_overview.OnlineStatus" BloodlineName="_bloodlineName" />
                </div>
            </div>
        }

        <!-- Skills Tab -->
        @if (_activeTab == "skills")
        {
            <div class="tab-content">
                <SkillsList Skills="_skills" SkillsLoaded="_skillsLoaded" />
            </div>
        }

        <div class="refresh-section">
            <button class="refresh-button" @onclick="LoadCharacterData" disabled="@_isRefreshing">
                @if (_isRefreshing)
                {
                    <span class="spinner-small"></span>
                    <span>Aktualisiere...</span>
                }
                else
                {
                    <span>ðŸ”„ Daten aktualisieren</span>
                }
            </button>
            @if (_lastUpdated.HasValue)
            {
                <span class="last-updated">Zuletzt aktualisiert: @_lastUpdated.Value.ToString("HH:mm:ss")</span>
            }
        </div>
    }
</div>

@code {
    private bool _isLoading = true;
    private bool _isRefreshing;
    private bool _isAuthenticated;
    private CharacterOverview? _overview;
    private DateTime? _lastUpdated;
    private string? _errorMessage;
    private string _loadingStatus = "Lade Charakterdaten...";
    private string? _shipClass;
    private SolarSystemInfo? _systemInfo;
    private string? _bloodlineName;
    private List<SkillInfo> _skills = new();
    private string _activeTab = "overview";
    private bool _skillsLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("Character page initializing...");

        var authState = await AuthService.GetAuthStateAsync();
        _isAuthenticated = authState?.IsValid == true;

        Logger.LogInformation("Authentication state: {IsAuth}, CharacterId: {CharId}",
            _isAuthenticated, authState?.CharacterId);

        if (_isAuthenticated)
        {
            await LoadCharacterData();
        }
        else
        {
            _isLoading = false;
        }
    }

    private async Task LoadCharacterData()
    {
        if (_isRefreshing) return;

        _isRefreshing = true;
        _errorMessage = null;
        _loadingStatus = "Lade Charakterdaten von ESI...";

        Logger.LogInformation("Starting to load character data...");

        try
        {
            _overview = await EveApi.GetCharacterOverviewAsync();

            if (_overview != null)
            {
                Logger.LogInformation("Successfully loaded character: {Name}", _overview.Character.Name);
                _lastUpdated = DateTime.Now;

                // SDE-Daten laden (parallel fÃ¼r bessere Performance)
                await LoadSdeDataAsync();
            }
            else
            {
                Logger.LogWarning("GetCharacterOverviewAsync returned null");
                _errorMessage = "Keine Daten von der API erhalten.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading character data");
            _errorMessage = $"Fehler beim Laden: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            _isRefreshing = false;
            Logger.LogInformation("Finished loading, _isLoading={IsLoading}, _overview is null={IsNull}",
                _isLoading, _overview == null);
        }
    }

    private async Task LoadSdeDataAsync()
    {
        if (_overview == null) return;

        try
        {
            // PrÃ¼fen ob SDE verfÃ¼gbar ist
            var sdeAvailable = await SdeService.IsDatabaseAvailableAsync();
            if (!sdeAvailable)
            {
                Logger.LogWarning("SDE database not available, skipping SDE data");
                return;
            }

            // Ship-Klasse laden
            if (_overview.CurrentShip?.ShipTypeId != null)
            {
                _shipClass = await SdeService.GetTypeGroupAsync(_overview.CurrentShip.ShipTypeId);
                Logger.LogDebug("Ship class loaded: {Class}", _shipClass);
            }

            // System + Region laden
            if (_overview.Location?.SolarSystemId != null)
            {
                _systemInfo = await SdeService.GetSolarSystemAsync(_overview.Location.SolarSystemId);
                Logger.LogDebug("System info loaded: {System} in {Region}",
                    _systemInfo?.Name, _systemInfo?.RegionName);
            }

            // Bloodline (Rasse) laden
            if (_overview.Character.BloodlineId != null)
            {
                _bloodlineName = await SdeService.GetBloodlineNameAsync(_overview.Character.BloodlineId);
                Logger.LogDebug("Bloodline loaded: {Bloodline}", _bloodlineName);
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Error loading SDE data (continuing without)");
            // Kein _errorMessage setzen - SDE ist optional
        }
    }

    private async Task LoadSkillsAsync()
    {
        if (_skillsLoaded) return; // Nur einmal laden

        try
        {
            _loadingStatus = "Lade Skills...";

            var skillsData = await EveApi.GetCharacterSkillsAsync();
            if (skillsData?.Skills != null)
            {
                var sdeAvailable = await SdeService.IsDatabaseAvailableAsync();
                if (sdeAvailable)
                {
                    _skills = await SdeService.GetSkillDetailsAsync(skillsData.Skills);
                    Logger.LogInformation("Loaded {Count} skills with SDE details", _skills.Count);
                }
                else
                {
                    Logger.LogWarning("SDE not available, cannot load skill names");
                    _errorMessage = "SDE-Datenbank nicht verfÃ¼gbar. Bitte auf der Settings-Seite herunterladen.";
                }
            }

            _skillsLoaded = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading skills");
            _errorMessage = $"Fehler beim Laden der Skills: {ex.Message}";
        }
    }

    private async Task SwitchTabAsync(string tab)
    {
        _activeTab = tab;

        // Skills beim ersten Ã–ffnen des Tabs laden
        if (tab == "skills" && !_skillsLoaded)
        {
            await LoadSkillsAsync();
        }
    }
}
