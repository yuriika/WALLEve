@using WALLEve.Configuration
@inherits LayoutComponentBase
@inject IEveAuthenticationService AuthService
@inject NavigationManager Navigation
@inject ISdeUpdateService SdeService
@inject IOptions<EveOnlineSettings> Settings

<div class="app-container">
    <nav class="sidebar">
        <div class="sidebar-header">
            <img src="images/eve-logo.svg" alt="EVE" class="eve-logo" />
            <h1>Companion</h1>
        </div>
        
        <div class="nav-section">
            <a class="nav-item @GetActiveClass("/")" href="/">
                <span class="nav-icon">üè†</span>
                <span class="nav-text">Home</span>
            </a>
            
            @if (_isAuthenticated)
            {
                <a class="nav-item @GetActiveClass("/character")" href="/character">
                    <span class="nav-icon">üë§</span>
                    <span class="nav-text">Charakter</span>
                </a>

                <a class="nav-item @GetActiveClass("/settings")" href="/settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">Einstellungen</span>
                </a>
                
                <div class="nav-section-divider"></div>
                <span class="nav-section-title">Weitere Features</span>
                
                <span class="nav-item disabled">
                    <span class="nav-icon">üì¶</span>
                    <span class="nav-text">Assets</span>
                    <span class="coming-soon">Bald</span>
                </span>
                
                <span class="nav-item disabled">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">Markt</span>
                    <span class="coming-soon">Bald</span>
                </span>
            }
        </div>
        
        <div class="sidebar-footer">
            @if (_isAuthenticated)
            {
                <div class="user-info">
                    <span class="character-name">@_characterName</span>
                    <button class="logout-btn" @onclick="LogoutAsync">
                        Abmelden
                    </button>
                </div>
            }
            else
            {
                <span class="not-logged-in">Nicht angemeldet</span>
            }
        </div>
    </nav>
    
    <main class="main-content">
        @Body
    </main>
</div>

@code {
    private bool _isAuthenticated;
    private string _characterName = string.Empty;
    private string _currentPath = "/";

    protected override async Task OnInitializedAsync()
    {
        _currentPath = new Uri(Navigation.Uri).AbsolutePath;
        Navigation.LocationChanged += OnLocationChanged;
        await UpdateAuthState();
        AuthService.AuthenticationStateChanged += OnAuthStateChanged;

        // SDE-Check beim Start (nur wenn nicht schon auf Settings-Seite)
        if (!_currentPath.StartsWith("/settings"))
        {
            await CheckSdeRequirement();
        }
    }

    private async Task CheckSdeRequirement()
    {
        try
        {
            if (await SdeService.RequiresSetupAsync())
            {
                Navigation.NavigateTo("/settings?reason=setup");
            }
        }
        catch (Exception ex)
        {
            // Bei Fehlern nicht blockieren, nur loggen
            Console.WriteLine($"SDE check failed: {ex.Message}");
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        _currentPath = new Uri(e.Location).AbsolutePath;
        InvokeAsync(StateHasChanged);
    }

    private string GetActiveClass(string path)
    {
        if (path == "/" && _currentPath == "/") return "active";
        if (path != "/" && _currentPath.StartsWith(path)) return "active";
        return "";
    }

    private void NavigateTo(string path)
    {
        Navigation.NavigateTo(path);
    }

    private async Task UpdateAuthState()
    {
        var authState = await AuthService.GetAuthStateAsync();
        _isAuthenticated = authState?.IsValid == true;
        _characterName = authState?.CharacterName ?? string.Empty;
    }

    private async void OnAuthStateChanged(object? sender, bool isAuthenticated)
    {
        await UpdateAuthState();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LogoutAsync()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/", forceLoad: true);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        AuthService.AuthenticationStateChanged -= OnAuthStateChanged;
    }
}
